<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Image to ASCII Art Converter</title>
    <style>
        #image-preview {
            max-width: 400px;
            max-height: 400px;
            margin-bottom: 20px;
        }

        input[type="file"] {
            border: 0;
            clip: rect(0, 0, 0, 0);
            overflow: hidden;
            padding: 0;
            white-space: nowrap;
        }

        .btn {
            display: inline-block;
            min-width: 100px;
            line-height: 40px;
            margin: 5px 2px 20px 2px;
            font-size: 15px;
            text-align: center;
            color: #fff;
            cursor: pointer;
            background-color: teal;
        }
    </style>

</head>

<body>
    <input type="file" id="input-image" accept="image/*" />
    <img id="image-preview" />
    <br />
    <a id="save-btn" class="btn">Save</a>

    <br />
    <pre id="ascii-image"></pre>

    <script>
        const inputImage = document.getElementById("input-image");
        const imagePreview = document.getElementById("image-preview");
        const asciiImage = document.getElementById("ascii-image");
        inputImage.addEventListener("change", () => {
            const file = inputImage.files[0];
            const reader = new FileReader();

            reader.addEventListener("load", () => {
                imagePreview.src = reader.result;
                const img = new Image();

                img.addEventListener("load", () => {
                    const canvas = document.createElement("canvas");
                    const naturalWidth = img.naturalWidth;
                    const naturalHeight = img.naturalHeight;

                    // Tính toán kích thước mới của canvas
                    const maxWidth = 600; // Kích thước tối đa của canvas
                    const maxHeight = 600;
                    let canvasWidth = naturalWidth;
                    let canvasHeight = naturalHeight;
                    if (canvasWidth > maxWidth) {
                        canvasHeight *= maxWidth / canvasWidth;
                        canvasWidth = maxWidth;
                    }
                    if (canvasHeight > maxHeight) {
                        canvasWidth *= maxHeight / canvasHeight;
                        canvasHeight = maxHeight;
                    }

                    // Cập nhật kích thước mới cho canvas
                    canvas.width = canvasWidth;
                    canvas.height = canvasHeight;
                    const context = canvas.getContext("2d");
                    context.drawImage(img, 0, 0, canvasWidth, canvasHeight);
                    const asciiChars =
                        "*%=arn-t. " // Số ký tự ASCII được sử dụng trong kết quả
                            .split("")
                            .reverse();
                    const pixelData = context.getImageData(0, 0, canvas.width, canvas.height)
                        .data;

                    let asciiImageText = "";

                    for (let i = 0; i < pixelData.length; i += 4) {
                        const red = pixelData[i];
                        const green = pixelData[i + 1];
                        const blue = pixelData[i + 2];
                        const alpha = pixelData[i + 3];

                        const brightness = (red + green + blue) / 3;
                        const asciiIndex = Math.floor(
                            (brightness / 255) * (asciiChars.length - 1)
                        );

                        const asciiChar = asciiChars[asciiIndex];
                        asciiImageText += asciiChar;

                        if ((i + 4) % (canvas.width * 4) === 0) {
                            asciiImageText += "\n";
                        }
                    }

                    asciiImage.textContent = asciiImageText;
                });

                img.src = reader.result;
            });

            reader.readAsDataURL(file);
        });

        const saveBtn = document.getElementById('save-btn');

        // Thêm sự kiện click vào nút Save
        saveBtn.addEventListener('click', function () {


            // Tạo canvas và thiết lập kích thước cho canvas bằng kích thước của element pre
            const canvas = document.createElement("canvas");
            canvas.width = asciiImage.offsetWidth * 3;
            canvas.height = asciiImage.offsetHeight;

            // Lấy context 2D của canvas
            const ctx = canvas.getContext("2d");

            // Vẽ nội dung của pre lên canvas
            ctx.fillStyle = "white"; // Thiết lập màu nền cho canvas
            ctx.fillRect(0, 0, canvas.width, canvas.height); // Vẽ hình chữ nhật màu trắng để làm nền
            ctx.font = "22px monospace"; // Thiết lập font chữ và kích thước
            ctx.fillStyle = "black"; // Thiết lập màu chữ
            const lines = asciiImage.innerHTML.split("\n"); // Tách nội dung của pre thành các dòng
            for (let i = 0; i < lines.length; i++) {
                ctx.fillText(lines[i], 0, (i + 1) * 10); // Vẽ các dòng lên canvas
            }

            // Tạo một link download và thiết lập thuộc tính href cho link đó
            const downloadLink = document.createElement("a");
            downloadLink.href = canvas.toDataURL("image/png");
            downloadLink.download =  `image_${new Date().getTime()}.png`;

            // Thêm link download vào body và click vào nó để download file ảnh
            document.body.appendChild(downloadLink);
          setTimeout(() => {
                downloadLink.click();
            }, 3000);

        });
    </script>
</body>

</html>
